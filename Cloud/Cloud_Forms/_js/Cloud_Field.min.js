var CloudField=function(e){function n(e,n,r){typeof r=="undefined"&&(r=!1);t.hasOwnProperty(e)?t[e].push({fnct_name:n,args:r}):console.warn("CloudField has no action "+e)}function r(n,r){if(t.hasOwnProperty(n))for(i in t[n])t[n][i].fnct_name(e,r,t[n][i].args)}var t={init:[]},s=function(t,n){e(".cloneable",n).each(function(){function l(){n=t.getClonePart(".clone");i=t.getClonePart(".add");s=t.getClonePart(".remove");var r=0;n.each(function(){var t=e(this),n=t.find("input, textarea, select").not('[type="button"], .copy_to_use input');n.each(function(){var n=e(this).parents(".field"),i=e(this).attr("name");if(i!==undefined){var s=!1;e(this).parents(".clone").size()==2&&e(this).parents(".clone").first()[0]!==t[0]&&(s=!0);s?e(this).attr("name",replaceNthMatch(e(this).attr("name"),/(\[\d+\])/g,"first","["+r+"]")):e(this).attr("name",replaceNthMatch(e(this).attr("name"),/(\[\d+\])/g,"last","["+r+"]"))}var o=e(this).attr("id");if(typeof o!="undefined"){var u=o.replace(/(-\d+)/g,"-"+r);e(this).attr("id",u);t.getClonePart("label[for='"+o+"']").attr("for",u)}});var i=e(this).getClonePart(".copy_to_use").find("input");i.each(function(){var n=!1;e(this).parents(".clone").size()==2&&e(this).parents(".clone").first()[0]!==t[0]&&(n=!0);var i=e(this).attr("value");n?e(this).val(replaceNthMatch(i,/( \d+)/g,"first"," "+r)):e(this).val(replaceNthMatch(i,/( \d+)/g,"last"," "+r))});r++;t.getClonePart(".number").text(r)})}function c(i){if(!i.hasClass("disabled")){var s=n.size();if(i.parents(".no-clones").size()>0)var a=e();else var a=i.parents(".clone").first();var f=u.clone(!1).hide();f.getClonePart("input, textarea, select").not('[type="button"],[type="checkbox"][type="radio"], .copy_to_use input').val("");f.getClonePart(".error").remove();f.getClonePart(".preview-image").attr("src","").addClass("hidden").hide();a.size()>0?f.insertAfter(a).fadeIn():f.prependTo(t).fadeIn();p();o(f);r("init",f);f.find('input[type="text"], input[type="number"], textarea, select').focus()}}function h(e){if(!e.hasClass("disabled")){var t=e.parents(".clone").first(),r=n.size();t.slideUp("fast",function(){t.remove();l();p()})}}function p(){l();n.size()===a?s.addClass("disabled"):s.removeClass("disabled");n.size()===f?i.addClass("disabled"):i.removeClass("disabled");i.unbind("click.cloneable").on("click.cloneable",function(){c(e(this))});s.unbind("click.cloneable").on("click.cloneable",function(){h(e(this))})}if(e(this).parents(".to-clone").size()>0)return!1;if(e(this).data("cloneable")==1)return!1;e(this).data("cloneable",!0);var t=e(this),n,i,s,u,a=typeof t.data("min")!="undefined"?t.data("min"):0,f=typeof t.data("max")!="undefined"?t.data("max"):!1;u=t.getClonePart(".to-clone").clone(!1).removeClass("to-clone");t.getClonePart(".to-clone").remove();t.parents(".no-sort").size()==0&&t.sortable({update:l});p();t.find(".empty-text").first().on("click.cloneable",function(){i.first().trigger("click")});r("init",t)})},o=function(t,n){e(".copy_to_use",n).click(function(t){e(".copy_to_use.active").removeClass("active");t.preventDefault();var n=e(this).find("input"),r=e(this);n.select();r.addClass("active")})};e(function(){e(".cloud-form").each(function(){var t=e(this);n("init",o);n("init",s);r("init",t)})});return{on:n}}(jQuery);jQuery.fn.getClonePart=function(e){if(this.hasClass("cloneable")&&this.parents(".cloneable").size()>0){var t=this.find(e);return t}if(this.hasClass("clone")&&this.parents(".cloneable").size()==2){var t=this.find(e);return t}var n=e.split(","),t=this.find(e);for(i in n)n[i]=".clone .cloneable "+n[i];t=t.not(n.join(", "));return t};var replaceNthMatch=function(e,t,n,r){var i,s;if(t.constructor===RegExp){if(e.search(t)===-1)return e;i=e.split(t);if(i[1].search(t)!==0)throw{name:"ArgumentError",message:"RegExp must have a capture group"}}else{if(t.constructor!==String)throw{name:"ArgumentError",message:"Must provide either a RegExp or String"};i=e.split(t);s=[];for(var o=0;o<i.length;o++){s.push(i[o]);o<i.length-1&&s.push(t)}i=s}switch(n){case"first":n=1;break;case"last":n=Math.floor(i.length/2)}indexOfNthMatch=n*2-1;if(i[indexOfNthMatch]===undefined)return e;typeof r=="function"&&(r=r(i[indexOfNthMatch]));i[indexOfNthMatch]=r;return i.join("")};